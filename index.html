<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Team Automator v5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .main-content {
            margin-left: 250px;
        }
        .report-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .report-card:hover {
            transform: translateY(-5px);
        }
        .scroll-container {
            max-height: 500px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #e5e7eb;
        }
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">
    <!-- Sidebar -->
    <aside class="sidebar p-6 flex flex-col items-center space-y-8 shadow-2xl rounded-tr-3xl rounded-br-3xl">
        <div class="flex items-center space-x-2 p-2 rounded-xl transition duration-300">
            <svg class="h-8 w-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m-6 0v-6a2 2 0 012-2h2a2 2 0 012 2v6m-4 0a2 2 0 002 2h2a2 2 0 002-2" />
            </svg>
            <span class="text-2xl font-bold text-gray-100">AI Automator</span>
        </div>
        <nav class="w-full space-y-4">
            <a href="#" class="flex items-center space-x-4 p-3 rounded-lg bg-gray-700 text-white font-medium shadow-lg transition duration-300 hover:scale-105 hover:bg-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
                <span>Dashboard</span>
            </a>
            <a href="#" class="flex items-center space-x-4 p-3 rounded-lg text-gray-400 font-medium transition duration-300 hover:scale-105 hover:bg-gray-700 hover:text-white">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Storia</span>
            </a>
            <a href="#" class="flex items-center space-x-4 p-3 rounded-lg text-gray-400 font-medium transition duration-300 hover:scale-105 hover:bg-gray-700 hover:text-white">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-.97 1.659-.97 2.085 0l3.42 7.828a1 1 0 00.95.636h9.091c.8 0 1.258.948.747 1.583l-7.749 8.046a1 1 0 01-.703.293h-1.921c-.8 0-1.258-.948-.747-1.583l-7.749-8.046a1 1 0 01-.703-.293z" />
                </svg>
                <span>Impostazioni</span>
            </a>
            <a href="#" class="flex items-center space-x-4 p-3 rounded-lg text-gray-400 font-medium transition duration-300 hover:scale-105 hover:bg-gray-700 hover:text-white">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Aiuto</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content flex-1 p-6 sm:p-12 space-y-8">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div class="space-y-1">
                <h1 class="text-3xl font-bold text-gray-900">Buonasera, Team!</h1>
                <p class="text-gray-600">Dai un'occhiata agli aggiornamenti di oggi e inserisci il tuo.</p>
            </div>
        </header>

        <!-- Sezione per l'input dell'utente -->
        <main class="w-full flex flex-col gap-6">
            <div class="report-card p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Il tuo Aggiornamento</h2>
                <div class="space-y-4">
                    <div>
                        <label for="yesterday" class="block text-gray-700 font-medium">Ieri:</label>
                        <textarea id="yesterday" rows="3" class="mt-1 w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></textarea>
                    </div>
                    <div>
                        <label for="today" class="block text-gray-700 font-medium">Oggi:</label>
                        <textarea id="today" rows="3" class="mt-1 w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></textarea>
                    </div>
                    <div>
                        <label for="blockers" class="block text-gray-700 font-medium">Ostacoli:</label>
                        <textarea id="blockers" rows="3" class="mt-1 w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-center">
                    <button id="submitButton" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105 active:scale-95 disabled:bg-gray-400">
                        Salva Aggiornamento
                    </button>
                </div>
            </div>

            <!-- Dashboard del team (mostra i report salvati) -->
            <section class="report-card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Aggiornamenti del Team</h2>
                    <span id="statusMessage" class="text-sm font-medium text-gray-500">Connessione in corso...</span>
                </div>
                <div id="teamReports" class="scroll-container space-y-4">
                    <!-- I report verranno inseriti qui dal database -->
                    <div id="noReportsMessage" class="text-center text-gray-500 italic">Nessun aggiornamento ancora.</div>
                </div>
            </section>
        </main>

        <footer class="text-center text-sm text-gray-500 mt-8">
            <p>ID Utente (per i test): <span id="userIdDisplay" class="font-mono text-gray-700 break-all"></span></p>
        </footer>
    </div>

    <script type="module">
        // Importa le librerie Firebase necessarie
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabili globali fornite dall'ambiente Canvas. NON modificarle.
        // PER IL TESTING IN LOCALE, DEVI INSERIRE QUI LA TUA CONFIGURAZIONE DI FIREBASE.
        // ESEMPIO:
        // const firebaseConfigPlaceholder = {
        //     apiKey: "YOUR_API_KEY",
        //     authDomain: "YOUR_AUTH_DOMAIN",
        //     projectId: "YOUR_PROJECT_ID",
        //     storageBucket: "YOUR_STORAGE_BUCKET",
        //     messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        //     appId: "YOUR_APP_ID"
        // };

        const appId = 1:516502511573:web:869293b18ade900e50e75c;
       const firebaseConfig = {
  apiKey: "AIzaSyBAuhf1wpC-eoK2jgL1U9JYfCnuwVOD7Ls",
  authDomain: "report-ai-automator.firebaseapp.com",
  projectId: "report-ai-automator",
  storageBucket: "report-ai-automator.firebasestorage.app",
  messagingSenderId: "516502511573",
  appId: "1:516502511573:web:869293b18ade900e50e75c",
  measurementId: "G-Z04WGWJYKM"
};;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inizializza Firebase e i servizi
        let app, db, auth, userId = null;

        const yesterdayInput = document.getElementById('yesterday');
        const todayInput = document.getElementById('today');
        const blockersInput = document.getElementById('blockers');
        const submitButton = document.getElementById('submitButton');
        const teamReportsDiv = document.getElementById('teamReports');
        const statusMessage = document.getElementById('statusMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const noReportsMessage = document.getElementById('noReportsMessage');

        // Funzione per inizializzare l'app e autenticare l'utente
        async function initializeAppAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    // Gestisce l'autenticazione
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            userIdDisplay.textContent = userId;
                            statusMessage.textContent = 'Connesso e in tempo reale.';
                            // Avvia l'ascolto dei dati solo dopo l'autenticazione
                            listenForReports();
                        } else {
                            statusMessage.textContent = 'Autenticazione in corso...';
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                    });
                } else {
                    statusMessage.textContent = 'Errore: Configurazione Firebase non trovata. Inserisci le tue credenziali per il testing locale.';
                    submitButton.disabled = true;
                }
            } catch (error) {
                console.error("Errore nell'inizializzazione di Firebase:", error);
                statusMessage.textContent = 'Errore di connessione.';
                submitButton.disabled = true;
            }
        }

        // Funzione per salvare i dati nel database
        async function saveReport() {
            if (!userId) {
                statusMessage.textContent = 'Utente non autenticato. Riprova.';
                return;
            }

            const yesterday = yesterdayInput.value.trim();
            const today = todayInput.value.trim();
            const blockers = blockersInput.value.trim();

            if (yesterday === '' || today === '' || blockers === '') {
                statusMessage.textContent = 'Per favore, compila tutti i campi.';
                return;
            }

            submitButton.disabled = true;
            statusMessage.textContent = 'Salvataggio...';

            try {
                const reportsCollectionPath = `artifacts/${appId}/public/data/reports`;
                await addDoc(collection(db, reportsCollectionPath), {
                    yesterday: yesterday,
                    today: today,
                    blockers: blockers,
                    userId: userId,
                    timestamp: new Date()
                });
                yesterdayInput.value = '';
                todayInput.value = '';
                blockersInput.value = '';
                statusMessage.textContent = 'Aggiornamento salvato con successo!';
            } catch (e) {
                console.error("Errore nell'aggiungere il documento: ", e);
                statusMessage.textContent = 'Errore nel salvataggio del report.';
            } finally {
                submitButton.disabled = false;
            }
        }

        // Funzione per ascoltare i cambiamenti nel database in tempo reale
        function listenForReports() {
            if (!db) return;

            const reportsCollectionPath = `artifacts/${appId}/public/data/reports`;
            const q = query(collection(db, reportsCollectionPath), orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                teamReportsDiv.innerHTML = '';
                if (snapshot.empty) {
                    noReportsMessage.style.display = 'block';
                } else {
                    noReportsMessage.style.display = 'none';
                    snapshot.forEach((doc) => {
                        const report = doc.data();
                        const reportCard = document.createElement('div');
                        reportCard.className = "bg-white rounded-lg shadow p-4 space-y-2";
                        
                        const header = document.createElement('div');
                        header.className = "flex justify-between items-center";
                        const reportHeader = document.createElement('h3');
                        reportHeader.className = "text-md font-semibold text-blue-600";
                        reportHeader.textContent = `Aggiornamento di: ${report.userId}`;
                        const timestampSpan = document.createElement('span');
                        timestampSpan.className = "text-xs text-gray-400";
                        timestampSpan.textContent = new Date(report.timestamp.seconds * 1000).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                        header.appendChild(reportHeader);
                        header.appendChild(timestampSpan);
                        
                        const yesterdayDiv = document.createElement('div');
                        yesterdayDiv.innerHTML = `<span class="font-semibold text-gray-700">Ieri:</span> <span class="text-gray-600">${report.yesterday}</span>`;
                        
                        const todayDiv = document.createElement('div');
                        todayDiv.innerHTML = `<span class="font-semibold text-gray-700">Oggi:</span> <span class="text-gray-600">${report.today}</span>`;
                        
                        const blockersDiv = document.createElement('div');
                        blockersDiv.innerHTML = `<span class="font-semibold text-gray-700">Ostacoli:</span> <span class="text-gray-600">${report.blockers}</span>`;

                        reportCard.appendChild(header);
                        reportCard.appendChild(yesterdayDiv);
                        reportCard.appendChild(todayDiv);
                        reportCard.appendChild(blockersDiv);
                        
                        teamReportsDiv.appendChild(reportCard);
                    });
                }
            }, (error) => {
                console.error("Errore nell'ascolto dei dati: ", error);
                statusMessage.textContent = 'Errore di connessione al database.';
            });
        }

        // Aggiunge l'evento al pulsante Salva
        submitButton.addEventListener('click', saveReport);

        // Avvia l'app all'inizio
        initializeAppAndAuth();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Team Automator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#181a1f',
                        secondary: '#1f2127',
                        tertiary: '#292b32',
                        accent: '#3b82f6',
                        lightText: '#e2e8f0',
                        mutedText: '#a0aec0',
                        activeLink: '#0f172a',
                        activeLinkIcon: '#e2e8f0',
                        success: '#10b981',
                        danger: '#ef4444',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: 0, transform: 'translateY(10px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' },
                        },
                        slideInLeft: {
                            '0%': { transform: 'translateX(-20px)', opacity: 0 },
                            '100%': { transform: 'translateX(0)', opacity: 1 },
                        }
                    },
                    animation: {
                        fadeIn: 'fadeIn 0.5s ease-out forwards',
                        slideInLeft: 'slideInLeft 0.5s ease-out forwards',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2127;
            color: #e2e8f0;
        }
        .card {
            background-color: #292b32;
            border: 1px solid #374151;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            backdrop-filter: blur(10px);
        }
        .sidebar {
            background-color: #181a1f;
            color: #a0aec0;
            border-right: 1px solid #374151;
        }
        .sidebar-link.active {
            background-color: #3b82f6;
            color: white;
        }
        .sidebar-link.active .icon-class {
            color: white;
        }
        .sidebar-link {
            transition: all 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: rgba(59, 130, 246, 0.2);
            color: white;
        }
        .badge {
            background-color: #4b5563;
            color: #e2e8f0;
            border-radius: 9999px;
            padding: 2px 8px;
            font-size: 12px;
        }
        .dropdown-menu {
            background-color: #292b32;
            border: 1px solid #374151;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dropdown-item:hover {
            background-color: #3b82f6;
        }
        .chart-container {
            height: 300px;
        }
        .button-primary {
            background-color: #3b82f6;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .button-primary:hover {
            background-color: #2563eb;
        }
        .button-secondary {
            background-color: #4a5568;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .button-secondary:hover {
            background-color: #2d3748;
        }
        .input-field {
            background-color: #1f2127;
            border: 1px solid #4a5568;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .prose strong {
            color: #e2e8f0;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, limit, serverTimestamp, updateDoc, getDocs, deleteDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Firebase variables and initialization
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const isFirebaseAvailable = !!firebaseConfig && !!initialAuthToken;

        let app, auth, db;
        if (isFirebaseAvailable) {
            setLogLevel('debug');
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } else {
            console.warn("Firebase config not found. The application will run, but reports will not be saved or synchronized.");
        }

        let userId = null;
        let chartInstance = null;
        let teamMembers = [];
        
        window.saveReport = async function(reporterName, yesterday, today, blockers, assignedToEmail, assignedToName) {
            if (!isFirebaseAvailable) {
                console.warn("Firebase not available. Report will not be saved.");
                return;
            }
            const reportRef = getReportRef();
            if (!reportRef) {
                console.error("Firestore not initialized.");
                return;
            }
            try {
                const docData = {
                    reporterName: reporterName,
                    yesterday: yesterday,
                    today: today,
                    blockers: blockers,
                    timestamp: serverTimestamp(),
                    userId: userId
                };
                if (assignedToEmail && assignedToName) {
                    docData.assignedToEmail = assignedToEmail;
                    docData.assignedToName = assignedToName;
                }
                const docRef = await addDoc(reportRef, docData);
                console.log("Document written with ID: ", docRef.id);
                return docRef.id;
            } catch (e) {
                console.error("Error adding document: ", e);
                return null;
            }
        }

        window.getUserId = () => userId;
        
        // Firestore references
        function getReportRef() {
            if (!userId || !db) {
                return null;
            }
            return collection(db, `artifacts/${appId}/public/data/standup_reports`);
        }
        
        function getTeamRef() {
            if (!userId || !db) {
                return null;
            }
            return collection(db, `artifacts/${appId}/users/${userId}/team_members`);
        }
        
        // Team Members management
        async function loadTeamMembers() {
            if (!isFirebaseAvailable) return;
            const teamRef = getTeamRef();
            if (!teamRef) return;
            try {
                const snapshot = await getDocs(teamRef);
                teamMembers = snapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name, email: doc.data().email }));
                populateTeamMembers('blocker-assignee-select');
                renderTeamMembersList();
            } catch (e) {
                console.error("Error loading team members:", e);
            }
        }
        
        async function addTeamMember(memberName, memberEmail) {
            if (!isFirebaseAvailable) {
                console.warn("Firebase not available. Team member will not be saved.");
                return;
            }
            const teamRef = getTeamRef();
            if (!teamRef) return;
            if (teamMembers.some(member => member.email === memberEmail)) {
                console.log("Team member already exists.");
                return;
            }
            try {
                await addDoc(teamRef, { name: memberName, email: memberEmail });
                await loadTeamMembers();
            } catch (e) {
                console.error("Error adding team member:", e);
            }
        }

        async function deleteTeamMember(memberId) {
            if (!isFirebaseAvailable) {
                console.warn("Firebase not available. Team member will not be deleted.");
                return;
            }
            const teamRef = getTeamRef();
            if (!teamRef) return;
            try {
                await deleteDoc(doc(teamRef, memberId));
                await loadTeamMembers();
            } catch (e) {
                console.error("Error deleting team member:", e);
            }
        }
        
        function renderTeamMembersList() {
            const teamList = document.getElementById('team-members-list');
            if (!teamList) return;
            teamList.innerHTML = '';
            
            if (teamMembers.length === 0) {
                teamList.innerHTML = '<p class="text-mutedText text-sm italic">Nessun membro del team aggiunto.</p>';
                return;
            }
            
            teamMembers.forEach(member => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-secondary p-2 rounded-md transition-colors duration-200 hover:bg-tertiary';
                li.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-lightText text-sm font-semibold">${member.name}</span>
                        <span class="text-mutedText text-xs">${member.email}</span>
                    </div>
                    <button data-id="${member.id}" class="delete-member-btn text-danger hover:text-red-700 transition-colors duration-200">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                teamList.appendChild(li);
            });
        }

        function populateTeamMembers(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;
            selectElement.innerHTML = '<option value="">Seleziona un membro del team</option>';
            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.email;
                option.textContent = member.name;
                selectElement.appendChild(option);
            });
        }

        function attachFirestoreListener() {
            if (!isFirebaseAvailable) return;

            const reportRef = getReportRef();
            if (!reportRef) {
                console.error("User ID not set, cannot attach listener.");
                return;
            }
            
            const q = query(reportRef, orderBy('timestamp', 'desc'), limit(5));

            onSnapshot(q, (snapshot) => {
                const reports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateChart(reports);
                renderPastReports(snapshot.docs);
            }, (error) => {
                console.error("Error listening to Firestore:", error);
            });
        }
        
        function renderPastReports(docs) {
            const pastReportsList = document.getElementById('past-reports');
            if (!pastReportsList) return;
            pastReportsList.innerHTML = '';
            
            if (docs.length === 0) {
                 pastReportsList.innerHTML = '<p class="italic text-mutedText">Nessun report del team trovato.</p>';
                 return;
            }

            docs.forEach(doc => {
                const report = doc.data();
                const timestamp = report.timestamp ? new Date(report.timestamp.seconds * 1000) : new Date();
                const formattedDate = timestamp.toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const hasBlockers = report.blockers && report.blockers.toLowerCase() !== 'no' && report.blockers.trim() !== '';

                const li = document.createElement('li');
                li.className = 'border-b border-tertiary pb-4 last:border-b-0 last:pb-0 pt-4 first:pt-0 animate-fadeIn';
                li.innerHTML = `
                    <p class="text-xs font-semibold text-mutedText">Reporter: <span class="font-normal text-lightText">${report.reporterName || 'Sconosciuto'}</span></p>
                    <p class="text-sm font-semibold text-lightText mt-1">${formattedDate}</p>
                    <p class="text-sm mt-1 text-mutedText"><strong>Completato:</strong> ${report.yesterday}</p>
                    <p class="text-sm mt-1 text-mutedText"><strong>Obiettivi:</strong> ${report.today}</p>
                    <p class="text-sm mt-1 text-mutedText"><strong>Ostacoli:</strong> ${hasBlockers ? report.blockers : 'Nessuno'}</p>
                    ${report.assignedToName ? `
                        <p class="mt-2 text-sm text-mutedText"><strong>Assegnato a:</strong> ${report.assignedToName}</p>
                    ` : ''}
                `;
                pastReportsList.appendChild(li);
            });
        }

        function updateChart(reports) {
            const blockersCount = {
                'API': 0,
                'Team': 0,
                'Requisiti': 0,
                'Bug': 0,
                'Altro': 0
            };

            reports.forEach(report => {
                const blockersText = report.blockers ? report.blockers.toLowerCase() : '';
                if (blockersText && blockersText !== 'no' && blockersText !== 'nessuno' && blockersText.trim() !== '') {
                    if (blockersText.includes('api') || blockersText.includes('backend')) {
                        blockersCount['API']++;
                    } else if (blockersText.includes('team') || blockersText.includes('collaborazione')) {
                        blockersCount['Team']++;
                    } else if (blockersText.includes('requisiti') || blockersText.includes('specifiche')) {
                        blockersCount['Requisiti']++;
                    } else if (blockersText.includes('bug')) {
                        blockersCount['Bug']++;
                    } else {
                        blockersCount['Altro']++;
                    }
                }
            });

            const ctx = document.getElementById('blockersChart').getContext('2d');
            if (chartInstance) {
                chartInstance.data.datasets[0].data = Object.values(blockersCount);
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(blockersCount),
                        datasets: [{
                            label: 'Numero di Ostacoli',
                            data: Object.values(blockersCount),
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.6)',
                                'rgba(249, 115, 22, 0.6)',
                                'rgba(234, 179, 8, 0.6)',
                                'rgba(132, 204, 22, 0.6)',
                                'rgba(100, 116, 139, 0.6)'
                            ],
                            borderColor: [
                                'rgba(239, 68, 68, 1)',
                                'rgba(249, 115, 22, 1)',
                                'rgba(234, 179, 8, 1)',
                                'rgba(132, 204, 22, 1)',
                                'rgba(100, 116, 139, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#a0aec0' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#a0aec0' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Tipi di Ostacoli Frequenti',
                                color: '#e2e8f0'
                            }
                        }
                    }
                });
            }
        }

        async function generatePdf() {
            const aiSummary = document.getElementById('ai-summary-text').textContent;
            const yesterdayTasks = Array.from(document.querySelectorAll('#yesterday-list li input:checked + span')).map(span => span.textContent);
            const yesterdayText = yesterdayTasks.length > 0 ? yesterdayTasks.join(', ') : 'Nessuna attività completata';
            const todayText = document.getElementById('today').value;
            const blockersText = document.getElementById('blockers').value;
            const reporterName = document.getElementById('my-name-input').value;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            const margin = 20;
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            let y = margin;
            const lineHeight = 10;
            const todayDate = new Date().toLocaleDateString('it-IT');

            pdf.setFillColor(59, 130, 246);
            pdf.rect(0, 0, pageWidth, 25, 'F');

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(18);
            pdf.setTextColor(255, 255, 255);
            pdf.text('Report Stand-up Giornaliero', margin, 17);

            pdf.setFontSize(10);
            pdf.setTextColor(255, 255, 255);
            pdf.text(`Data: ${todayDate}`, pageWidth - margin, 17, { align: 'right' });

            y = 40;
            pdf.setTextColor(0, 0, 0);

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(14);
            pdf.text('Riassunto AI', margin, y);
            y += lineHeight;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(12);
            const splitSummary = pdf.splitTextToSize(aiSummary, pageWidth - margin * 2);
            pdf.text(splitSummary, margin, y);
            y += (splitSummary.length * lineHeight) + lineHeight;

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(14);
            pdf.text('Attività Completate Oggi', margin, y);
            y += lineHeight;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(12);
            const splitYesterday = pdf.splitTextToSize(yesterdayText, pageWidth - margin * 2);
            pdf.text(splitYesterday, margin, y);
            y += (splitYesterday.length * lineHeight) + lineHeight;

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(14);
            pdf.text('Obiettivi per Domani', margin, y);
            y += lineHeight;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(12);
            const splitToday = pdf.splitTextToSize(todayText, pageWidth - margin * 2);
            pdf.text(splitToday, margin, y);
            y += (splitToday.length * lineHeight) + lineHeight;

            const hasBlockers = blockersText && blockersText.toLowerCase() !== 'no' && blockersText.trim() !== '';
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(14);
            pdf.text('Ostacoli', margin, y);
            y += lineHeight;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(12);
            const blockersContent = hasBlockers ? blockersText : 'Nessuno';
            const splitBlockers = pdf.splitTextToSize(blockersContent, pageWidth - margin * 2);
            pdf.text(splitBlockers, margin, y);
            y += (splitBlockers.length * lineHeight) + lineHeight;

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(14);
            pdf.text(`Report di: ${reporterName || 'Sconosciuto'}`, margin, y);
            y += lineHeight;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(12);
            pdf.text(`ID Utente: ${userId}`, margin, y);

            pdf.setFontSize(10);
            pdf.setTextColor(150, 150, 150);
            const footerText = 'Generato da AI Team Stand-up Automator';
            const textWidth = pdf.getStringUnitWidth(footerText) * pdf.internal.getFontSize() / pdf.internal.scaleFactor;
            const xOffset = (pageWidth - textWidth) / 2;
            pdf.text(footerText, xOffset, pageHeight - margin);

            pdf.save('report_standup.pdf');
        }

        async function getAiSummary(yesterday, today, blockers) {
            const systemPrompt = "Sei un Project Manager esperto. Analizza i seguenti aggiornamenti di stand-up e fornisci un riassunto conciso, professionale e formattato in un singolo paragrafo. Evita i saluti e le conclusioni. Concentrati sulle attività chiave completate, gli obiettivi per domani e gli eventuali ostacoli. Utilizza il pronome 'loro' o 'il team' per riferirti alla persona che ha scritto il report.";
            const userQuery = `Oggi: ${yesterday}\nDomani: ${today}\nOstacoli: ${blockers}`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "No AI summary generated.";
                return text;
            } catch (e) {
                console.error("Error in Gemini API call:", e);
                return "Error in generating AI summary.";
            }
        }

        async function getSentimentAnalysis(yesterday, today, blockers) {
            const systemPrompt = "Sei un analista AI specializzato nell'analisi del sentiment. Analizza il seguente testo e restituisci una singola parola che descrive il sentiment generale: 'Positivo', 'Neutro', o 'Negativo'. Non aggiungere spiegazioni o punteggiatura, solo la parola.";
            const userQuery = `Report di stand-up:\nAttività completate: ${yesterday}\nObiettivi futuri: ${today}\nOstacoli: ${blockers}`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Neutro";
                return text;
            } catch (e) {
                console.error("Error in Gemini API call for sentiment:", e);
                return "Neutro";
            }
        }

        async function copyToClipboard(text) {
            try {
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = text;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextarea);
                return true;
            } catch (e) {
                console.error("Error copying to clipboard:", e);
                return false;
            }
        }

        function handleDownloadAndShare() {
            generatePdf();
            const downloadMessage = document.getElementById('download-message');
            downloadMessage.textContent = "Il tuo report PDF è stato scaricato. Ora puoi trovarlo nella tua cartella 'Download' e allegarlo alla chat di WhatsApp.";
            downloadMessage.classList.remove('hidden');
            downloadMessage.classList.add('animate-fadeIn');
            setTimeout(() => downloadMessage.classList.add('hidden'), 5000);
        }

        function initializeAppLogic() {
            const teamMemberForm = document.getElementById('team-member-form');
            const yesterdayInput = document.getElementById('yesterday-input');
            const addYesterdayTaskBtn = document.getElementById('add-yesterday-task-btn');
            const yesterdayList = document.getElementById('yesterday-list');
            const blockersTextarea = document.getElementById('blockers');
            const assigneeDiv = document.getElementById('blocker-assignee-div');
            const assigneeSelect = document.getElementById('blocker-assignee-select');
            const form = document.getElementById('standup-form');
            const reportOutput = document.getElementById('report-output');
            const newReportBtn = document.getElementById('new-report-btn');
            const submitBtn = document.getElementById('submit-btn');
            const newReportBtnDiv = document.getElementById('new-report-btn-div');
            const userIdDisplay = document.getElementById('user-id-display');
            const notificationMessageDiv = document.getElementById('notification-sent-message');
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.main-section');
            const mobileSidebarBtn = document.getElementById('mobile-sidebar-btn');
            const sidebar = document.getElementById('sidebar');

            if (userIdDisplay) {
                userIdDisplay.textContent = userId || 'Non disponibile';
            }
            if (userId === null) {
                 const pastReportsSection = document.getElementById('past-reports-section');
                 if(pastReportsSection) pastReportsSection.classList.add('hidden');
                 const userIdNote = document.getElementById('user-id-note');
                 if(userIdNote) userIdNote.innerHTML = 'Funzionalità di salvataggio/condivisione non attiva. Per usare il database, carica questo file in un ambiente supportato.';
            }

            // Tabs/sections logic
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    link.classList.add('active');
                    sections.forEach(sec => sec.classList.add('hidden'));
                    const target = link.getAttribute('data-target');
                    const targetSection = document.getElementById(target);
                    if (targetSection) {
                        targetSection.classList.remove('hidden');
                    }
                });
            });

            // Mobile sidebar
            mobileSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });

            // Show/hide assignee select based on blockers textarea content
            blockersTextarea.addEventListener('input', () => {
                if (blockersTextarea.value.trim() !== '') {
                    assigneeDiv.classList.remove('hidden');
                } else {
                    assigneeDiv.classList.add('hidden');
                    assigneeSelect.value = "";
                }
            });

            // Event listener for the team member addition form
            teamMemberForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const memberNameInput = document.getElementById('team-member-name-input');
                const memberEmailInput = document.getElementById('team-member-email-input');
                const memberName = memberNameInput.value.trim();
                const memberEmail = memberEmailInput.value.trim();

                if (memberName && memberEmail) {
                    await addTeamMember(memberName, memberEmail);
                    memberNameInput.value = '';
                    memberEmailInput.value = '';
                }
            });

            // Delegation for deleting team members
            const teamMembersList = document.getElementById('team-members-list');
            if (teamMembersList) {
                teamMembersList.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-member-btn')) {
                        const memberId = e.target.closest('.delete-member-btn').dataset.id;
                        deleteTeamMember(memberId);
                    }
                });
            }

            // Add a task to the list
            addYesterdayTaskBtn.addEventListener('click', () => {
                const taskText = yesterdayInput.value.trim();
                if (taskText) {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between py-2 text-lightText animate-slideInLeft';
                    li.innerHTML = `
                        <div class="flex items-center">
                            <input type="checkbox" class="task-checkbox mr-3 accent-blue-500 w-4 h-4 rounded-full" checked>
                            <span>${taskText}</span>
                        </div>
                        <button type="button" class="text-mutedText hover:text-danger ml-2 transition-colors duration-200 delete-task-btn">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    yesterdayList.appendChild(li);
                    yesterdayInput.value = '';
                }
            });

            // Delegation for deleting tasks
            if (yesterdayList) {
                yesterdayList.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-task-btn')) {
                        e.target.closest('li').remove();
                    }
                });
            }

            const steps = {
                1: document.getElementById('step-1'),
                2: document.getElementById('step-2'),
                3: document.getElementById('step-3'),
                4: document.getElementById('step-4'),
            };

            const resetFlow = () => {
                Object.values(steps).forEach((step, index) => {
                    if (step) {
                        step.classList.remove('processing', 'completed');
                    }
                });
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const myName = document.getElementById('my-name-input').value.trim();
                const yesterdayTasks = Array.from(document.querySelectorAll('#yesterday-list li input:checked + span')).map(span => span.textContent);
                const yesterdayText = yesterdayTasks.join(', ');
                const today = document.getElementById('today').value;
                const blockers = blockersTextarea.value;
                const assignedToEmail = assigneeSelect.value;
                const assignedToName = assigneeSelect.options[assigneeSelect.selectedIndex]?.text || '';

                if (!myName) {
                    reportOutput.innerHTML = `<p class="text-danger">Per favore, inserisci il tuo nome.</p>`;
                    return;
                }
                if (yesterdayTasks.length === 0 || !today) {
                    reportOutput.innerHTML = `<p class="text-danger">Per favore, spunta almeno un'attività e compila il campo "obiettivi per domani".</p>`;
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.classList.add('hidden');
                newReportBtnDiv.classList.add('hidden');
                reportOutput.innerHTML = `
                    <div id="loading-spinner" class="flex flex-col items-center justify-center p-8 text-mutedText">
                        <i class="fas fa-spinner fa-spin text-accent text-3xl"></i>
                        <p class="mt-4">Generazione del report in corso...</p>
                        <p id="loading-step-1" class="mt-2 text-sm text-center">Analisi del contenuto e generazione del riassunto...</p>
                        <p id="loading-step-2" class="mt-2 text-sm text-center">Analisi del sentiment del team...</p>
                        <p id="loading-step-3" class="mt-2 text-sm text-center">Salvataggio del report...</p>
                    </div>
                `;

                resetFlow();
                let currentStep = 1;

                const step1 = document.getElementById('step-1');
                if (step1) {
                    step1.classList.add('completed');
                    currentStep++;
                }

                try {
                    const step2 = document.getElementById('step-2');
                    if (step2) {
                        step2.classList.add('processing');
                    }

                    const loadingStep1 = document.getElementById('loading-step-1');
                    if (loadingStep1) loadingStep1.textContent = "Analisi del contenuto e generazione del riassunto... Completato!";
                    const loadingStep2 = document.getElementById('loading-step-2');
                    if (loadingStep2) loadingStep2.textContent = "Analisi del sentiment del team...";
                    const loadingStep3 = document.getElementById('loading-step-3');
                    if (loadingStep3) loadingStep3.textContent = "Salvataggio del report...";

                    const aiSummary = await getAiSummary(yesterdayText, today, blockers);
                    const sentiment = await getSentimentAnalysis(yesterdayText, today, blockers);
                    let docId = null;
                    if (isFirebaseAvailable) {
                      docId = await window.saveReport(myName, yesterdayText, today, blockers, assignedToEmail, assignedToName);
                    } else {
                      docId = 'local-report';
                    }
                    
                    const step3 = document.getElementById('step-3');
                    if (step2) step2.classList.remove('processing');
                    if (step3) {
                        step3.classList.add('completed');
                    }
                    const step4 = document.getElementById('step-4');
                    if (step4) {
                        step4.classList.add('completed');
                    }
                    
                    displayReport(docId, myName, yesterdayText, today, blockers, aiSummary, sentiment, assignedToName, assignedToEmail);

                } catch (e) {
                    console.error("An error occurred while generating the report:", e);
                    reportOutput.innerHTML = `<p class="text-danger">Si è verificato un errore durante la generazione del report. Riprova.</p>`;
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('hidden');
                    newReportBtnDiv.classList.remove('hidden');
                }
            });

            const displayReport = (docId, reporterName, yesterday, today, blockers, aiSummary, sentiment, assignedToName, assignedToEmail) => {
                const hasBlockers = blockers && blockers.toLowerCase() !== 'no' && blockers.trim() !== '';
                let sentimentText = 'Neutro';
                let sentimentEmoji = '😐';
                let sentimentColor = 'text-mutedText';

                if (sentiment.toLowerCase().includes('positivo')) {
                    sentimentText = 'Positivo';
                    sentimentEmoji = '😀';
                    sentimentColor = 'text-success';
                } else if (sentiment.toLowerCase().includes('negativo')) {
                    sentimentText = 'Negativo';
                    sentimentEmoji = '😞';
                    sentimentColor = 'text-danger';
                }
                const encodedBlockers = encodeURIComponent(blockers);
                const encodedSubject = encodeURIComponent(`Aggiornamento Stand-up: Ostacolo da risolvere`);
                const encodedBody = encodeURIComponent(`Ciao ${assignedToName},\n\nTi scrivo in merito all'ostacolo segnalato durante lo stand-up di oggi:\n\n"${blockers}"\n\nGrazie per l'aiuto!`);
                const mailtoLink = `mailto:${assignedToEmail}?subject=${encodedSubject}&body=${encodedBody}`;

                const reportHTML = `
                    <div id="report-pdf-content" class="p-6 card rounded-xl shadow-lg animate-fadeIn">
                        <h3 class="font-bold text-lightText text-2xl mb-4">Report del Giorno</h3>

                        <div class="flex items-center mb-4">
                            <span class="mr-2 text-2xl ${sentimentColor}">${sentimentEmoji}</span>
                            <p class="text-mutedText"><strong class="${sentimentColor}">Sentiment del Team:</strong> ${sentimentText}</p>
                        </div>

                        <div class="mb-4">
                            <h4 class="font-semibold text-lightText text-lg mb-2">Riassunto AI</h4>
                            <p id="ai-summary-text" class="text-mutedText prose leading-relaxed">${aiSummary}</p>
                        </div>
                        <div class="mb-4">
                            <h4 class="font-semibold text-lightText text-lg mb-2">Dettagli Originali</h4>
                            <ul class="list-disc list-inside space-y-1 text-mutedText">
                                <li><strong>Report di:</strong> ${reporterName}</li>
                                <li><strong>Completato Oggi:</strong> ${yesterday}</li>
                                <li><strong>Obiettivi per Domani:</strong> ${today}</li>
                            </ul>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-semibold text-lightText text-lg mb-2">Stato e Ostacoli</h4>
                            <div class="flex items-center">
                                ${hasBlockers
                                    ? `<span class="mr-2 text-2xl animate-pulse text-danger">❗️</span> <p class="text-mutedText"><strong class="text-danger">Ostacolo Rilevato:</strong> ${blockers}</p>`
                                    : `<span class="mr-2 text-2xl text-success">✅</span> <p class="text-mutedText"><strong class="text-success">Nessun ostacolo</strong> segnalato.</p>`
                                }
                            </div>
                            ${assignedToName ? `
                                <p class="mt-2 text-sm text-mutedText"><strong>Assegnato a:</strong> ${assignedToName}</p>
                                <a href="${mailtoLink}" id="email-blocker-btn" class="mt-4 inline-flex items-center justify-center button-primary">
                                    <i class="fas fa-envelope mr-2"></i>
                                    <span>Invia Ostacolo via Email</span>
                                </a>
                            ` : ''}
                        </div>
                    </div>
                    <div id="share-options" class="mt-6">
                        <h4 class="font-semibold text-lightText text-lg mb-2">Opzioni di Condivisione</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="download-and-share-btn" class="flex-1 flex items-center justify-center button-primary">
                                <i class="fas fa-download mr-2"></i>
                                <span>Scarica e Condividi PDF</span>
                            </button>
                            <button id="copy-summary-btn" class="flex-1 flex items-center justify-center button-secondary">
                                <i class="fas fa-clipboard mr-2"></i>
                                <span>Copia Riassunto</span>
                            </button>
                        </div>
                        <p id="download-message" class="text-center text-accent mt-4 hidden"></p>
                        <p id="copy-status" class="text-center text-success mt-4 hidden">Copiato negli appunti!</p>
                    </div>
                `;
                reportOutput.innerHTML = reportHTML;
                
                document.getElementById('download-and-share-btn').addEventListener('click', handleDownloadAndShare);
                document.getElementById('copy-summary-btn').addEventListener('click', () => {
                    const aiSummaryText = document.getElementById('ai-summary-text').textContent;
                    copyToClipboard(aiSummaryText).then(success => {
                        const copyStatus = document.getElementById('copy-status');
                        if (success) {
                            copyStatus.textContent = 'Copiato negli appunti!';
                            copyStatus.classList.remove('hidden');
                            copyStatus.classList.add('animate-fadeIn');
                            setTimeout(() => copyStatus.classList.add('hidden'), 3000);
                        } else {
                            copyStatus.textContent = 'Errore nella copia.';
                            copyStatus.classList.remove('hidden');
                            copyStatus.classList.add('text-danger');
                        }
                    });
                });
            };

            newReportBtn.addEventListener('click', () => {
                form.reset();
                yesterdayList.innerHTML = '';
                assigneeDiv.classList.add('hidden');
                resetFlow();
                reportOutput.innerHTML = '<p class="italic text-mutedText">Il report generato apparirà qui dopo aver inviato il modulo.</p>';
                submitBtn.classList.remove('hidden');
                newReportBtnDiv.classList.remove('hidden');
            });

            resetFlow();
        }

        (async () => {
            try {
                if (isFirebaseAvailable) {
                    const token = initialAuthToken;
                    if (token) {
                        await signInWithCustomToken(auth, token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    const user = auth.currentUser;
                    userId = user ? user.uid : crypto.randomUUID();
                    console.log(`User authenticated with ID: ${userId}`);
                    await loadTeamMembers();
                    attachFirestoreListener();
                } else {
                    userId = null;
                }
                
                document.addEventListener('DOMContentLoaded', initializeAppLogic);

            } catch (e) {
                console.error("Authentication failed:", e);
                const userIdDisplay = document.getElementById('user-id-display');
                if (userIdDisplay) {
                    userIdDisplay.textContent = 'Autenticazione fallita';
                }
            }
        })();
    </script>
</head>
<body class="bg-secondary text-lightText flex">

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar w-64 p-4 min-h-screen flex flex-col justify-between fixed lg:relative -translate-x-full lg:translate-x-0 transition-transform duration-300 z-50">
        <div>
            <div class="flex items-center mb-8 p-2">
                <i class="fas fa-brain text-accent text-3xl mr-3"></i>
                <h1 class="text-xl font-bold">AI Automator</h1>
            </div>
            <nav>
                <ul>
                    <li>
                        <a href="#" class="nav-link active flex items-center p-3 rounded-md text-sm font-medium" data-target="dashboard-section">
                            <i class="fas fa-home icon-class w-5 h-5 mr-3"></i>
                            <span class="ml-1">Home</span>
                        </a>
                    </li>
                    <li class="mt-2">
                        <a href="#" class="nav-link flex items-center p-3 rounded-md text-sm font-medium text-mutedText hover:text-lightText hover:bg-tertiary" data-target="report-form-section">
                            <i class="fas fa-tasks icon-class w-5 h-5 mr-3"></i>
                            <span class="ml-1">I miei Compiti</span>
                        </a>
                    </li>
                    <li class="mt-2">
                        <a href="#" class="nav-link flex items-center p-3 rounded-md text-sm font-medium text-mutedText hover:text-lightText hover:bg-tertiary" data-target="report-form-section">
                            <i class="fas fa-chart-line icon-class w-5 h-5 mr-3"></i>
                            <span class="ml-1">Analisi</span>
                        </a>
                    </li>
                    <li class="mt-2">
                        <a href="#" class="nav-link flex items-center p-3 rounded-md text-sm font-medium text-mutedText hover:text-lightText hover:bg-tertiary" data-target="team-members-section">
                            <i class="fas fa-users icon-class w-5 h-5 mr-3"></i>
                            <span class="ml-1">Team</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <div class="mt-auto">
            <p id="user-id-note" class="text-xs text-mutedText">ID Utente: <span id="user-id-display" class="font-mono text-lightText break-all">Caricamento...</span></p>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 p-4 lg:p-8 overflow-y-auto">
        <!-- Mobile Sidebar Toggle -->
        <button id="mobile-sidebar-btn" class="lg:hidden fixed top-4 left-4 z-50 p-2 rounded-full bg-secondary">
            <i class="fas fa-bars text-lightText"></i>
        </button>

        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div class="flex flex-col">
                <h2 class="text-3xl font-bold text-lightText">Home</h2>
                <p class="text-mutedText">Benvenuto, [Nome Utente]</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <input type="text" placeholder="Cerca..." class="input-field pl-10 pr-4">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-mutedText"></i>
                </div>
                <button class="bg-accent text-white rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-plus"></i>
                </button>
                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs font-bold text-white">JD</div>
            </div>
        </header>

        <!-- Sections (Main Content) -->
        <div id="dashboard-section" class="main-section grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            <!-- Card: Daily Report -->
            <div class="card p-6 col-span-1 md:col-span-2 lg:col-span-1">
                <h3 class="text-xl font-semibold mb-4">✍️ Crea un nuovo Report</h3>
                <p class="text-sm text-mutedText mb-4">Compila i campi sottostanti per generare il report del tuo stand-up.</p>
                <form id="standup-form" class="space-y-4">
                    <div>
                        <label for="my-name-input" class="block text-sm font-medium text-mutedText">Il mio nome</label>
                        <input id="my-name-input" type="text" class="input-field mt-1 w-full" placeholder="Es. Mario Rossi">
                    </div>
                    <div>
                        <label for="yesterday-input" class="block text-sm font-medium text-mutedText">Cosa hai completato oggi?</label>
                        <div class="flex mt-1">
                            <input id="yesterday-input" type="text" class="input-field flex-grow rounded-r-none" placeholder="Aggiungi un'attività...">
                            <button type="button" id="add-yesterday-task-btn" class="bg-accent text-white px-4 rounded-r-md hover:bg-blue-700 transition-colors duration-300">Aggiungi</button>
                        </div>
                        <ul id="yesterday-list" class="mt-2 space-y-2"></ul>
                    </div>
                    <div>
                        <label for="today" class="block text-sm font-medium text-mutedText">Obiettivi per domani</label>
                        <textarea id="today" name="today" rows="3" class="input-field mt-1 w-full" placeholder="Es: Inizierò a lavorare sull'integrazione del sistema di pagamento..."></textarea>
                    </div>
                    <div>
                        <label for="blockers" class="block text-sm font-medium text-mutedText">Ostacoli</label>
                        <textarea id="blockers" name="blockers" rows="2" class="input-field mt-1 w-full" placeholder="Es: No / Sì, sto aspettando le nuove API dal team backend..."></textarea>
                    </div>
                    <div id="blocker-assignee-div" class="hidden mt-4 p-4 card animate-fadeIn">
                        <label for="blocker-assignee-select" class="block text-sm font-medium text-mutedText">Assegna l'ostacolo a:</label>
                        <select id="blocker-assignee-select" class="input-field mt-1 w-full"></select>
                    </div>
                    <button type="submit" id="submit-btn" class="w-full button-primary">
                        Genera Report
                    </button>
                    <div id="new-report-btn-div" class="hidden">
                        <button type="button" id="new-report-btn" class="w-full button-secondary">
                            Nuovo Report
                        </button>
                    </div>
                </form>
            </div>

            <!-- Card: Generated Report -->
            <div class="card p-6 col-span-1 md:col-span-2 lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">📄 Report Generato</h3>
                </div>
                <div id="report-output" class="text-mutedText prose leading-relaxed">
                    <p class="italic">Il report generato apparirà qui dopo aver inviato il modulo.</p>
                </div>
            </div>

            <!-- Card: Team Activity Feed -->
            <div class="card p-6 col-span-1 md:col-span-2">
                <h3 class="text-xl font-semibold mb-4">📜 Feed del Team</h3>
                <div class="space-y-4">
                    <ul id="past-reports" class="list-none p-0">
                        <p class="italic text-mutedText">I report del team appariranno qui automaticamente.</p>
                    </ul>
                </div>
            </div>

            <!-- Card: Blockers Chart -->
            <div class="card p-6 col-span-1">
                <h3 class="text-xl font-semibold mb-4">📊 Dashboard di Analisi</h3>
                <p class="text-sm text-mutedText mb-4">Visualizza i trend del team nel tempo.</p>
                <div class="chart-container">
                    <canvas id="blockersChart"></canvas>
                </div>
            </div>

            <!-- Card: Team Management -->
            <div id="team-members-section" class="card p-6 col-span-1">
                <h3 class="text-xl font-semibold mb-4">👥 Gestione del Team</h3>
                <form id="team-member-form" class="mb-4">
                    <label class="block text-sm font-medium text-mutedText">Aggiungi un membro</label>
                    <div class="flex mt-1 space-x-2">
                        <input id="team-member-name-input" type="text" class="input-field flex-grow" placeholder="Nome">
                        <input id="team-member-email-input" type="email" class="input-field flex-grow" placeholder="Email">
                        <button type="submit" class="button-primary px-4 py-2 text-sm">Aggiungi</button>
                    </div>
                </form>
                <h4 class="text-lg font-semibold text-lightText mt-6">Membri</h4>
                <ul id="team-members-list" class="space-y-2 mt-4"></ul>
            </div>
        </div>
        
    </div>

</body>
</html>

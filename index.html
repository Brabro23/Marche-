<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Team Stand-up Automator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        setLogLevel('debug');

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let chartInstance = null;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.saveReport = async function(yesterday, today, blockers) {
            const reportRef = getReportRef();
            if (!reportRef) {
                console.error("Firestore not initialized.");
                return;
            }
            try {
                const docRef = await addDoc(reportRef, {
                    yesterday: yesterday,
                    today: today,
                    blockers: blockers,
                    timestamp: serverTimestamp()
                });
                console.log("Document written with ID: ", docRef.id);
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        window.getUserId = () => userId;

        function getReportRef() {
            if (!userId) {
                return null;
            }
            return collection(db, `artifacts/${appId}/users/${userId}/standup_reports`);
        }

        function attachFirestoreListener() {
            const reportRef = getReportRef();
            if (!reportRef) {
                console.error("User ID not set, cannot attach listener.");
                return;
            }

            onSnapshot(reportRef, (snapshot) => {
                const reports = snapshot.docs.map(doc => doc.data());
                updateChart(reports);
            }, (error) => {
                console.error("Error listening to Firestore:", error);
            });
        }

        function updateChart(reports) {
            const totalReports = reports.length;
            const reportsWithBlockers = reports.filter(r => r.blockers && r.blockers.toLowerCase() !== 'no' && r.blockers.trim() !== '').length;

            const blockersCount = {
                'API': 0,
                'Team': 0,
                'Requisiti': 0,
                'Bug': 0,
                'Altro': 0
            };

            reports.forEach(report => {
                const blockersText = report.blockers ? report.blockers.toLowerCase() : '';
                if (blockersText && blockersText !== 'no' && blockersText !== 'nessuno') {
                    if (blockersText.includes('api') || blockersText.includes('backend')) {
                        blockersCount['API']++;
                    } else if (blockersText.includes('team') || blockersText.includes('collaborazione')) {
                        blockersCount['Team']++;
                    } else if (blockersText.includes('requisiti') || blockersText.includes('specifiche')) {
                        blockersCount['Requisiti']++;
                    } else if (blockersText.includes('bug')) {
                        blockersCount['Bug']++;
                    } else {
                        blockersCount['Altro']++;
                    }
                }
            });

            if (chartInstance) {
                chartInstance.data.datasets[0].data = Object.values(blockersCount);
                chartInstance.update();
            } else {
                const ctx = document.getElementById('blockersChart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(blockersCount),
                        datasets: [{
                            label: 'Numero di Ostacoli',
                            data: Object.values(blockersCount),
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.6)',
                                'rgba(249, 115, 22, 0.6)',
                                'rgba(234, 179, 8, 0.6)',
                                'rgba(132, 204, 22, 0.6)',
                                'rgba(100, 116, 139, 0.6)'
                            ],
                            borderColor: [
                                'rgba(239, 68, 68, 1)',
                                'rgba(249, 115, 22, 1)',
                                'rgba(234, 179, 8, 1)',
                                'rgba(132, 204, 22, 1)',
                                'rgba(100, 116, 139, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Tipi di Ostacoli Frequenti'
                            }
                        }
                    }
                });
            }
        }
        
        // Logica principale dell'app, eseguita solo dopo l'autenticazione
        function initializeAppLogic() {
            const form = document.getElementById('standup-form');
            const reportOutput = document.getElementById('report-output');
            const shareButtons = document.getElementById('share-buttons');
            const userIdDisplay = document.getElementById('userIdDisplay');
            
            userIdDisplay.textContent = window.getUserId();

            const steps = {
                1: document.getElementById('step-1'),
                2: document.getElementById('step-2'),
                3: document.getElementById('step-3'),
                4: document.getElementById('step-4'),
            };

            const resetFlow = () => {
                Object.values(steps).forEach((step, index) => {
                    const icon = step.querySelector('.step-icon');
                    step.classList.remove('processing', 'completed');
                    icon.style.backgroundColor = index === 0 ? '#3b82f6' : '#a8a29e'; // blue for first, stone for others
                    icon.style.borderColor = index === 0 ? '#2563eb' : '#78716c';
                });
            };
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                resetFlow();
                
                const yesterday = document.getElementById('yesterday').value;
                const today = document.getElementById('today').value;
                const blockers = document.getElementById('blockers').value;

                if (!yesterday || !today) {
                    reportOutput.innerHTML = '<p class="text-red-500">Per favore, compila almeno i primi due campi.</p>';
                    return;
                }

                reportOutput.innerHTML = '<p class="italic">Generazione del report in corso...</p>';
                
                // Save the report to Firestore
                window.saveReport(yesterday, today, blockers);

                const simulateProcessing = () => {
                    let currentStep = 1;
                    
                    const processNextStep = () => {
                        if (currentStep > 4) {
                            displayReport(yesterday, today, blockers);
                            return;
                        }

                        if(currentStep > 1) {
                           steps[currentStep-1].classList.remove('processing');
                           steps[currentStep-1].classList.add('completed');
                        }
                        
                        steps[currentStep].classList.add('processing');
                        const icon = steps[currentStep].querySelector('.step-icon');
                        icon.style.backgroundColor = '#3b82f6';
                        icon.style.borderColor = '#2563eb';
                        
                        currentStep++;
                        setTimeout(processNextStep, 800);
                    };

                    processNextStep();
                };

                const displayReport = (yesterday, today, blockers) => {
                    const hasBlockers = blockers && blockers.toLowerCase() !== 'no' && blockers.trim() !== '';

                    const reportText = `Riepilogo Attivit√†:\n- Completato Ieri: ${yesterday}\n- Obiettivi per Oggi: ${today}\n- Ostacoli: ${hasBlockers ? blockers : 'Nessuno'}`;
                    
                    const reportHTML = `
                        <h3 class="font-semibold text-stone-800">Riepilogo Attivit√†</h3>
                        <ul class="list-disc pl-5 mt-2 space-y-1">
                            <li><strong>Completato Ieri:</strong> ${yesterday}</li>
                            <li><strong>Obiettivi per Oggi:</strong> ${today}</li>
                        </ul>
                        <h3 class="font-semibold text-stone-800 mt-4">Stato e Ostacoli</h3>
                        <div class="flex items-center mt-2">
                            ${hasBlockers 
                                ? `<span class="mr-2 text-2xl">‚ùóÔ∏è</span> <p><strong class="text-amber-600">Ostacolo Rilevato:</strong> ${blockers}</p>` 
                                : `<span class="mr-2 text-2xl">‚úÖ</span> <p><strong class="text-green-600">Nessun ostacolo</strong> segnalato.</p>`
                            }
                        </div>
                        <button id="share-report-btn" class="mt-6 w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                            Condividi Report
                        </button>
                    `;
                    reportOutput.innerHTML = reportHTML;
                    
                    document.getElementById('share-report-btn').addEventListener('click', () => {
                        const encodedText = encodeURIComponent(reportText);
                        const shareHTML = `
                            <p class="text-sm text-stone-600 mb-2">Scegli come inviare il report:</p>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <a href="mailto:?subject=Report%20Stand-up%20Giornaliero&body=${encodedText}" target="_blank" class="flex-1 text-center bg-gray-200 text-gray-800 p-2 rounded-lg hover:bg-gray-300">Email</a>
                                <a href="https://wa.me/?text=${encodedText}" target="_blank" class="flex-1 text-center bg-green-500 text-white p-2 rounded-lg hover:bg-green-600">WhatsApp</a>
                                <a href="https://t.me/share/url?url=&text=${encodedText}" target="_blank" class="flex-1 text-center bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">Telegram</a>
                            </div>
                        `;
                        shareButtons.innerHTML = shareHTML;
                    });
                };

                simulateProcessing();
            });
            resetFlow();
        }
        
        // Esegue la logica di inizializzazione dopo che l'utente √® stato autenticato.
        (async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                const user = auth.currentUser;
                if (user) {
                    userId = user.uid;
                } else {
                    userId = crypto.randomUUID();
                }
                console.log(`User authenticated with ID: ${userId}`);
                attachFirestoreListener();
                initializeAppLogic();
            } catch (e) {
                console.error("Authentication failed:", e);
            }
        })();
    </script>
</head>
<body class="bg-stone-50 text-stone-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-stone-900">AI Team Stand-up Automator</h1>
            <p class="mt-2 text-lg text-stone-600">Inserisci il tuo aggiornamento giornaliero e osserva la magia dell'automazione.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                    <h2 class="text-2xl font-semibold mb-4 text-stone-800">‚úçÔ∏è Inserisci il tuo Aggiornamento</h2>
                    <p class="text-stone-600 mb-6">Compila i campi sottostanti per generare il report del tuo stand-up.</p>
                    <form id="standup-form" class="space-y-4">
                        <div>
                            <label for="yesterday" class="block text-sm font-medium text-stone-700">Cosa hai completato ieri?</label>
                            <textarea id="yesterday" name="yesterday" rows="3" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Es: Ho finalizzato la feature di login..."></textarea>
                        </div>
                        <div>
                            <label for="today" class="block text-sm font-medium text-stone-700">Quali sono i tuoi obiettivi per oggi?</label>
                            <textarea id="today" name="today" rows="3" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Es: Inizier√≤ a lavorare sull'integrazione del sistema di pagamento..."></textarea>
                        </div>
                        <div>
                            <label for="blockers" class="block text-sm font-medium text-stone-700">Hai incontrato ostacoli?</label>
                            <textarea id="blockers" name="blockers" rows="2" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Es: No / S√¨, sto aspettando le nuove API dal team backend..."></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            Genera Report Automatico
                        </button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                    <h2 class="text-2xl font-semibold mb-6 text-stone-800">‚öôÔ∏è Come Funziona</h2>
                    <div id="automation-flow" class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-2">
                        <!-- Step 1 -->
                        <div id="step-1" class="step text-center w-full sm:w-1/4">
                            <div class="step-icon mx-auto flex items-center justify-center w-16 h-16 bg-blue-500 text-white rounded-full border-4 border-blue-600 text-2xl">ü§ù</div>
                            <p class="step-text mt-2 font-medium text-stone-700">Input Team</p>
                        </div>
                        <div class="w-1/4 h-1 bg-stone-200 hidden sm:block"></div>
                        <!-- Step 2 -->
                        <div id="step-2" class="step text-center w-full sm:w-1/4">
                            <div class="step-icon mx-auto flex items-center justify-center w-16 h-16 bg-stone-400 text-white rounded-full border-4 border-stone-500 text-2xl">üß†</div>
                            <p class="step-text mt-2 font-medium text-stone-700">Analisi AI</p>
                        </div>
                        <div class="w-1/4 h-1 bg-stone-200 hidden sm:block"></div>
                        <!-- Step 3 -->
                        <div id="step-3" class="step text-center w-full sm:w-1/4">
                            <div class="step-icon mx-auto flex items-center justify-center w-16 h-16 bg-stone-400 text-white rounded-full border-4 border-stone-500 text-2xl">üìã</div>
                            <p class="step-text mt-2 font-medium text-stone-700">Report Veloce</p>
                        </div>
                        <div class="w-1/4 h-1 bg-stone-200 hidden sm:block"></div>
                        <!-- Step 4 -->
                        <div id="step-4" class="step text-center w-full sm:w-1/4">
                            <div class="step-icon mx-auto flex items-center justify-center w-16 h-16 bg-stone-400 text-white rounded-full border-4 border-stone-500 text-2xl">üì®</div>
                            <p class="step-text mt-2 font-medium text-stone-700">Consegna</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-8">
                 <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200 min-h-[300px]">
                    <h2 class="text-2xl font-semibold mb-4 text-stone-800">üìÑ Report del Giorno</h2>
                    <div id="report-output" class="text-stone-600 prose">
                        <p class="italic">Il report generato apparir√† qui dopo aver inviato il modulo.</p>
                    </div>
                    <div id="share-buttons" class="mt-4"></div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                    <h2 class="text-2xl font-semibold mb-4 text-stone-800">üìä Dashboard di Analisi</h2>
                    <p class="text-stone-600 mb-6">Visualizza i trend del team nel tempo per identificare pattern e migliorare il flusso di lavoro.</p>
                    <div class="chart-container">
                        <canvas id="blockersChart"></canvas>
                    </div>
                    <p class="text-sm mt-4 text-stone-600">ID Utente: <span id="userIdDisplay">Caricamento...</span></p>
                </div>
            </div>

        </main>
    </div>
</body>
</html>
